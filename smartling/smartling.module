<?php

/**
 * @file
 * The Smartling module file.
 */
define('SMARTLING_KEY', 'smartling');

$log_mode = variable_get('smartling_log', 1);
define('SMARTLING_LOG', $log_mode);

$smartling_dir = variable_get('file_public_path');

if (is_null($smartling_dir)) {
  $smartling_dir = conf_path() . '/files/smartling';
}
else {
  $smartling_dir = $smartling_dir . '/smartling';
}

define('SMARTLING_DIRECTORY', $smartling_dir);

include_once('smartling.utils.inc');

// @TODO: check why files[] directive in .info do not work
include_once('includes/smartling.workers.inc');
include_once('includes/smartling.entity.inc');
include_once('includes/smartling.entityController.inc');
include_once('views/smartling.views.inc');
include_once('api/lib/SmartlingAPI.php');
include_once('api/lib/HttpClient.php');
//include_once('api/test/SmartlingAPITest.php');
//include_once('api/test/HttpClientTest.php');

/**
 * Implements hook_menu().
 */
function smartling_menu() {
  $items = array();

  $items['admin/config/regional/smartling'] = array(
    'title' => 'Smartling settings',
    'weight' => -99,
    'type' => MENU_NORMAL_ITEM,
    'file' => 'smartling.admin.inc',
    'page callback' => 'smartling_admin_configuration_view',
    'access arguments' => array('administer smartling'),
  );

  $items['smartling/download/%/%'] = array(
    'title' => 'Smartling settings',
    'type' => MENU_CALLBACK,
    'page callback' => 'smartling_download_translate',
    'page arguments' => array(2, 3),
    'access arguments' => array('administer smartling'),
  );

  $items['admin/content/smartling'] = array(
    'title' => 'Smartling Translations',
    'description' => 'Smartling Translations',
    'weight' => -10,
    'access arguments' => array('administer smartling'),
  );

  return $items;
}

/**
 * Implements hook_admin_paths().
 */
function smartling_admin_paths() {
  $paths = array(
    'admin/config/regional/smartling' => TRUE,
  );

  return $paths;
}

/**
 * Implements hook_menu_alter().
 *
 * Smartling use this hook for add update operations on admin/content page
 */
function smartling_menu_alter(&$items) {
  if (isset($items['admin/content'])) {
    $items['admin/content']['page arguments'][0] = 'smartling_node_admin_content';
  }
  $items['admin/content/smartling']['page callback'] = $items['admin/content/smartling/report-completed']['page callback'];
  $items['admin/content/smartling']['page arguments'] = $items['admin/content/smartling/report-completed']['page arguments'];
  $items['admin/content/smartling']['load arguments'] = $items['admin/content/smartling/report-completed']['load arguments'];
  $items['admin/content/smartling/report-completed']['type'] = MENU_DEFAULT_LOCAL_TASK;
}

/**
 * Implements hook_module_implements_alter().
 */
function smartling_module_implements_alter(&$implementations, $hook) {
  switch ($hook) {
    case 'menu_alter':

      break;
  }
}

/**
 * Implements hook_permission().
 */
function smartling_permission() {
  $permissions = array(
    'administer smartling' => array(
      'title' => 'Administer Smartling',
      'description' => t('Access the administrative settings for the module.')
    ),
    'administer smartling_entity_data entities' => array(
      'title' => t('Administer smartling_entity_data entities'),
    ),
    'view any smartling_entity_data entity' => array(
      'title' => t('View any Smartling Entity Data entity'),
    ),
    'edit any smartling_entity_data entity' => array(
      'title' => t('Edit any Smartling Entity Data entity'),
    ),
    'create smartling_entity_data entities' => array(
      'title' => t('Create Smartling Entity Data Entities'),
    ),
  );
  return $permissions;
}

/**
 * Implements hook_form_FORM_ID_alter().
 *
 * Enable Smartling translation on a node type
 */
function smartling_form_node_type_form_alter(&$form, &$form_state) {
  $label = t('Enabled Smartling translation');
  $details = t('It will be possible to use Smartling service for automatic content translation if "Enabled Smartling translation" is ticked.');

  $form['workflow']['language_content_type']['#options'][SMARTLING_KEY] = $label;
  $form['workflow']['language_content_type']['#description'] .= ' ' . $details;
  $form['#submit'][] = 'smartling_multilingual_support_node_type_submit';
}

function smartling_multilingual_support_node_type_submit(&$form, &$form_state) {
  //delete content type in smartling support types
  $smartling_translate_fields = variable_get('smartling_translate_fields', array());
  $type = $form_state['values']['type'];
  if ($form_state['values']['language_content_type'] != SMARTLING_KEY) {
    if (isset($smartling_translate_fields[$type])) {
      unset($smartling_translate_fields[$type]);
      variable_set('smartling_translate_fields', $smartling_translate_fields);
    }
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 *
 * Enable Smartling translation on a field type
 */
function smartling_form_field_ui_field_edit_form_alter(&$form, &$form_state) {
  if (!in_array($form['#field']['type'], array('text', 'text_long', 'text_textfield', 'text_textarea', 'text_with_summary', 'text_textarea_with_summary', 'field_collection_embed', 'link_field'))) {
    return $form;
  }
  if (smartling_supported_type($form['#instance']['bundle'])) {
    $default = 0;
    if (array_key_exists('smartling_translatable', $form['#field'])) {
      $default = $form['#field']['smartling_translatable'];
    }

    $form['field']['smartling_translatable'] = array(
      '#type' => 'checkbox',
      '#title' => t('Enable Smartling Translation'),
      '#description' => t('This allows fields to be translatable using the Smartling Platform.'),
      '#default_value' => $default,
    );

    $smartling_translate_fields = variable_get('smartling_translate_fields');

    if (isset($smartling_translate_fields[$form['#instance']['bundle']][$form['#instance']['field_name']])) {
      $form['field']['smartling_translatable']['#attributes']['checked'] = 'checked';
    }

    array_push($form['#submit'], 'smartling_update_field');
    return $form;
  }
}

/*
 * Saves data for smartling_form_field_ui_field_edit_form_alter()
 */

function smartling_update_field($form, $form_state) {
  $field_name = $form['#field']['field_name'];
  $field = field_info_field($field_name);
  $value = (int) $form['field']['smartling_translatable']['#value'];
  $type = $form_state['values']['instance']['bundle'];
  if ($value == 1) {
    $field['translatable'] = TRUE;
    field_update_field($field);
    $translate_filds = variable_get('smartling_translate_fields', array());
    $translate_filds[$type][$field_name] = $field_name;
    variable_set('smartling_translate_fields', $translate_filds);
    // This is needed for versions of Drupal core 7.10 and lower. See http://drupal.org/node/1380660 for details.
    drupal_static_reset('field_available_languages');
  }
  else {
    $translate_filds = variable_get('smartling_translate_fields', array());

    if (isset($translate_filds[$type][$field_name])) {
      unset($translate_filds[$type][$field_name]);

      if (count($translate_filds[$type]) == 0) {
        unset($translate_filds[$type]);
      }

      if ($translate_filds == array()) {
        variable_delete('smartling_translate_fields');
      }
      else {
        variable_set('smartling_translate_fields', $translate_filds);
      }
    }
  }
}

function smartling_get_node_settings_form($form, &$form_state) {
  if (smartling_supported_type($form['type']['#value'])) {

    smartling_translate_fields_is_set();

    $title = t('Smartling Translation');

    // Vertical Tab.
    $form['smartling'] = array(
      '#title' => t('Smartling management'),
      '#type' => 'fieldset',
      '#collapsible' => TRUE,
      '#collapsed' => TRUE,
      '#group' => 'additional_settings',
      '#attributes' => array('id' => array('smartling_fieldset')),
      '#attached' => array(
        'js' => array(
          drupal_get_path('module', 'smartling') . '/js/smartling_node_settings.js' => array(
            'type' => 'file',
          ),
        ),
      ),
      '#modal' => TRUE,
    );

    $form['smartling']['content'] = array(
      '#type' => 'container',
    );

    $form['smartling']['content']['note'] = array(
      '#type' => 'item',
      '#title' => $title,
      '#description' => t('The Smartlink Translation module was developed to help you tranlate your site. If Target Locale is checked, this locale has already been translated (Process - 100%).'),
    );

    $languages = language_list('language');
    $options = array();

    if (!is_null($form['nid']['#value'])) {
      $check = array();

      foreach ($languages as $langcode => $language) {
        if ($form['language']['#default_value'] != $langcode && $language->enabled != '0') {
          $entity_data = smartling_entity_load_by_conditions(array('rid' => $form['nid']['#value'], 'target_language' => $langcode));
          if ($entity_data !== FALSE) {
            $options[$langcode] = $language->name . ' - ' . $entity_data->progress . '%';
          }
          else {
            $options[$langcode] = $language->name;
          }
          $check[] = (smartling_entity_load_by_conditions(array('rid' => $form['nid']['#value'], 'target_language' => $langcode, 'progress' => 100))) ? $langcode : FALSE;
        }
      }

      $form['smartling']['content']['target'] = array(
        '#type' => 'checkboxes',
        '#title' => 'Target Locales',
        '#options' => $options,
        '#default_value' => $check,
      );
    }
    else {
      foreach ($languages as $langcode => $language) {
        $options[$langcode] = $language->name;
      }

      $form['smartling']['content']['target'] = array(
        '#type' => 'checkboxes',
        '#title' => 'Target Locales',
        '#options' => $options,
      );
    }

    $form['smartling']['submit_to_translate'] = array(
      '#type' => 'submit',
      '#value' => 'Send to Smartling',
      '#submit' => array('smartling_get_node_settings_form_submit'),
    );

    $form['smartling']['submit_to_download'] = array(
      '#type' => 'submit',
      '#value' => 'Download Translation',
      '#submit' => array('smartling_download_translate_form_submit'),
    );

    $form['smartling']['submit_to_check'] = array(
      '#type' => 'submit',
      '#value' => 'Check Status',
      '#submit' => array('smartling_check_translate_form_submit'),
    );
  }

  return $form;
}

/**
 * smartling_check_translate_form_submit
 */
function smartling_check_translate_form_submit($form, $form_state) {
  $nid = $form_state['values']['nid'];
  smartling_watchdog('Smartling start force check translated file for node id - @nid', TRUE, array('@nid' => $nid), WATCHDOG_INFO, l(t('Edit node'), 'node/' . $nid . '/edit'));

  global $user;

  foreach ($form_state['values']['target'] as $d_locale) {
    if ($d_locale !== 0 && ($d_locale !== $form_state['values']['language'])) {

      global $user;

      $entity_data = smartling_entity_load_by_conditions(array('rid' => $nid, 'target_language' => $d_locale));

      if ($entity_data != FALSE) {
        $s_locale = smartling_convert_locale_drupal_to_smatrtling($d_locale);

        $progress = smartling_check_translate($nid, $s_locale, $entity_data);

        $entity_data->progress = $progress;
        smartling_entity_data_save($entity_data);

        smartling_watchdog('Smartling finish force check translated file for node id - @nid, language - @language', TRUE, array('@nid' => $nid, '@language' => $d_locale), WATCHDOG_INFO, l(t('Edit node'), 'node/' . $nid . '/edit'));

        drupal_set_message(t('Check translation for @language, progress @progress %.', array('@language' => $d_locale, '@progress' => $progress)));
      }
      elseif ($entity_data == FALSE || empty($entity_data->translated_file_name)) {
        smartling_watchdog('Smartling FAIL force check translated file for node id - @nid, language - @language', TRUE, array('@nid' => $nid, '@language' => $d_locale), WATCHDOG_INFO, l(t('Edit node'), 'node/' . $nid . '/edit'));
        drupal_set_message(t('You did not send this entity to translate or that the task is in queue. Language - @language', array('@language' => $d_locale)));
      }
    }
  }
}

/**
 * smartling_download_translate_form_submit
 */
function smartling_download_translate_form_submit($form, $form_state) {
  $nid = $form_state['values']['nid'];
  smartling_watchdog('Smartling start force download translated file for node id - @nid', TRUE, array('@nid' => $nid), WATCHDOG_INFO, l(t('Edit node'), 'node/' . $nid . '/edit'));

  global $user;

  foreach ($form_state['values']['target'] as $d_locale) {
    if ($d_locale !== 0 && ($d_locale !== $form_state['values']['language'])) {

      global $user;

      $entity_data = smartling_entity_load_by_conditions(array('rid' => $nid, 'target_language' => $d_locale));

      if ($entity_data != FALSE) {

        $progress = smartling_download_translate($nid, $d_locale, $entity_data);

        $entity_data->target_language = $d_locale;
        $entity_data->submitter = $user->uid;
        $entity_data->submission_date = time();
        $entity_data->progress = $progress;
        smartling_entity_data_save($entity_data);

        smartling_watchdog('Smartling finish force download translated file for node id - @nid, language - @language', TRUE, array('@nid' => $nid, '@language' => $d_locale), WATCHDOG_INFO, l(t('Edit node'), 'node/' . $nid . '/edit'));

        drupal_set_message(t('Uploaded for language translation @language', array('@language' => $d_locale)));
      }
      elseif ($entity_data == FALSE || empty($entity_data->translated_file_name)) {
        smartling_watchdog('Smartling FAIL force download translated file for node id - @nid, language - @language', TRUE, array('@nid' => $nid, '@language' => $d_locale), WATCHDOG_INFO, l(t('Edit node'), 'node/' . $nid . '/edit'));
        drupal_set_message(t('You did not send this entity to translate or that the task is in queue. Language - @language', array('@language' => $d_locale)));
      }
    }
  }
}

/**
 * smartling_get_node_settings_form_submit
 */
function smartling_get_node_settings_form_submit($form, $form_state) {
  $nid = $form_state['values']['nid'];
  smartling_watchdog('Add smartling queue task for node id - @nid', TRUE, array('@nid' => $nid), WATCHDOG_INFO, l(t('Edit node'), 'node/' . $nid . '/edit'));

  global $user;

  $smartling_queue = DrupalQueue::get('smartling_send_to_translate');
  $smartling_queue->createQueue();
  $count_op = 0;

  foreach ($form_state['values']['target'] as $d_locale) {
    if ($d_locale !== 0 && ($d_locale !== $form_state['values']['language'])) {
      $s_locale = smartling_convert_locale_drupal_to_smatrtling($d_locale);
      if (smartling_supported_type($form_state['values']['type'])) {
        $obj = new stdClass;
        $obj->rid = $nid;
        $obj->type = $form_state['values']['type'];
        $obj->title = $form_state['values']['title'];
        $obj->original_language = $form_state['values']['language'];
        $obj->s_locale = $s_locale;
        $obj->submitter = $user->uid;
        // create queue item
        $smartling_queue->createItem($obj);
        $count_op++;
        unset($obj);
      }
    }
  }
  drupal_set_message(t('Smartling add @count operations', array('@count' => $count_op)));
}

/**
 * Implements hook_node_operations().
 */
function smartling_node_operations() {
  return array(
    'smartling_translate' => array(
      'label' => t('Translate selected content (Smartling)'),
      'callback' => NULL,
    ),
  );
}

/**
 * Implements hook_form_BASE_FORM_ID_alter().
 *
 * @param array $form
 *   A FAPI form array for the form being altered.
 * @param array $form_state
 *   A FAPI form state array for the form being altered.
 * @param string $form_id
 *   The ID of the form being altered.
 */
function smartling_form_node_form_alter(&$form, $form_state, $form_id) {

  if (!smartling_supported_type($form['#node']->type)) {
    return;
  }

  $form = array_merge($form, smartling_get_node_settings_form($form, $form_state));
}

/**
 * Implements hook_node_presave().
 */
function smartling_node_presave($node) {
  // Make sure the title isn't overwritten with the translation when using the title module.
  if (module_exists('title') && array_key_exists('title_field', $node)) {
    if (isset($node->title_field[$node->language][0]['value'])) {
      $node->title = $node->title_field[$node->language][0]['value'];
    }
  }
}

/**
 * Implements hook_node_insert().
 */
function smartling_node_insert($node) {
  if (smartling_supported_type($node->type)) {
    foreach ($node->target as $locale) {
      if ($locale !== 0 && $locale !== $node->language) {
        $entity_data = smartling_entity_data_create();
        $entity_data->rid = $node->nid;
        $entity_data->bundle = $node->type;
        $entity_data->original_language = $node->language;
        $entity_data->target_language = $locale;
        $entity_data->submitter = $node->uid;
        $entity_data->submission_date = $node->created;

        smartling_entity_data_save($entity_data);
      }
    }
  }
}

/**
 * Implements hook_node_delete().
 */
function smartling_node_delete($node) {
  $entity_data = smartling_entity_load_by_conditions(array('rid' => $node->nid));
  if ($entity_data !== FALSE) {
    db_delete('smartling_entity_data')
        ->condition('rid', $entity_data->rid)
        ->execute();
  }
}

/**
 * Implementation of hook_views_api().
 */
function smartling_views_api() {
  return array(
    'api' => 3,
  );
}

/**
 * Implements hook_cron().
 */
function smartling_cron() {
  $check_queue = db_select('smartling_entity_data', 'sed')
      ->fields('sed', array('eid', 'rid', 'target_language'))
      ->condition('sed.progress', 100, '<>')
      ->execute()
      ->fetchAll();

  if (!empty($check_queue)) {
    $smartling_queue = DrupalQueue::get('smartling_check_status');
    $smartling_queue->createQueue();
    foreach ($check_queue as $gueue_item) {
      $obj = new stdClass;
      $obj->eid = $gueue_item->eid;
      $obj->rid = $gueue_item->rid;
      $obj->d_locale = $gueue_item->target_language;

      $smartling_queue->createItem($obj);
      smartling_watchdog('Add item to "smartling_check_status" queue. Smartling entity data id - @eid, related entity id - @rid', TRUE, array('@eid' => $gueue_item->eid, '@rid' => $gueue_item->rid), WATCHDOG_INFO);
      unset($obj);
    }
  }
}

/**
 * Implements hook_cron_queue_info().
 */
function smartling_cron_queue_info() {
  $queues['smartling_send_to_translate'] = array(
    'worker callback' => 'smartling_queue_send_to_translate_process',
    'time' => variable_get('smartling_mass_time', 58),
  );
  $queues['smartling_check_status'] = array(
    'worker callback' => 'smartling_queue_check_status_process',
    'time' => variable_get('smartling_mass_time', 58),
  );
  $queues['smartling_download_update_translated_item'] = array(
    'worker callback' => 'smartling_queue_download_update_translated_item_process',
    'time' => variable_get('smartling_mass_time', 58),
  );

  return $queues;
}

/**
 * Implements hook_entity_load().
 */
function smartling_entity_load($entities, $type) {
  if ($type == 'node') {

    foreach ($entities as $entity) {

      if (smartling_supported_type($entity->type)) {
        smartling_translate_fields_is_set();
        $fields = variable_get('smartling_translate_fields');

        foreach ($fields[$entity->type] as $field_name) {

          if (isset($entity->{$field_name}) && !empty($entity->{$field_name}) && isset($entity->{$field_name}[LANGUAGE_NONE]) && !isset($entity->{$field_name}[$entity->language])) {
            // if field have und value and dont have need value
            $entity->{$field_name}[$entity->language] = $entity->{$field_name}[LANGUAGE_NONE];
            smartling_watchdog('Smartlig add field value for @filedname, langcode @lang', TRUE, array('@filedname' => $field_name, '@lang' => $entity->language), WATCHDOG_INFO, l(t('Edit node'), 'node/' . $entity->nid));
          }
        }
      }
    }
  }
}

/**
 * Implements hook_views_pre_render().
 */
function smartling_views_pre_render(&$view) {
  if ($view->name == 'smartlig_report') {
    drupal_add_library('system', 'ui.progressbar');
    drupal_add_js(drupal_get_path('module', 'smartling') . '/js/smartling_admin.js');
  }
}
